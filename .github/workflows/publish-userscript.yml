name: Publish Userscript

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"
  workflow_run:
    workflows:
      - Auto Bump Userscript Version
    types:
      - completed

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version and tag
        id: version
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = 'bytebytego-references.user.js';
          if (!fs.existsSync(path)) {
              console.error(`Missing userscript: ${path}`);
              process.exit(1);
          }
          const content = fs.readFileSync(path, 'utf8');
          const match = content.match(/@version\s+([0-9.]+)/);
          if (!match) {
              console.error('Could not find @version in userscript header');
              process.exit(1);
          }
          const version = match[1].trim();
          const tag = `v${version}`;
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `version=${version}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `tag=${tag}\n`);
          console.log(`Extracted version ${version}, tag ${tag}`);
          NODE

      - name: Validate pushed tag matches version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          if [ "${{ github.ref_name }}" != "${{ steps.version.outputs.tag }}" ]; then
            echo "Pushed tag '${{ github.ref_name }}' does not match extracted tag '${{ steps.version.outputs.tag }}'"
            exit 1
          fi

      - name: Check for existing release
        id: guard
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "${{ steps.version.outputs.tag }}" >/dev/null 2>&1; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Release '${{ steps.version.outputs.tag }}' already exists. Skipping."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Package userscript asset
        if: steps.guard.outputs.skip != 'true'
        id: package
        run: |
          ASSET_PATH="bytebytego-references.user.js"
          ASSET_NAME="bytebytego-references.user.js"
          echo "asset_path=${ASSET_PATH}" >> "$GITHUB_OUTPUT"
          echo "asset_name=${ASSET_NAME}" >> "$GITHUB_OUTPUT"

      - name: Build release body with install link and generated notes
        if: steps.guard.outputs.skip != 'true'
        id: notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          INSTALL_BADGE="[![Install / Update](https://img.shields.io/badge/Install%20%2F%20Update-Userscript-brightgreen?logo=google-chrome&logoColor=white)](https://github.com/${{ github.repository }}/releases/download/${TAG}/bytebytego-references.user.js)"
          NOTES=$(gh api repos/${{ github.repository }}/releases/generate-notes -f tag_name="${TAG}" -f target_commitish="${{ github.sha }}" --jq '.body')
          CHANGELOG_SECTION="$(node - <<'NODE'
          const fs = require('fs');

          const version = process.env.VERSION;
          const changelogPath = 'changelog.json';
          const noEntry = () => { process.exit(0); };

          if (!version) {
            console.error('WARN: Missing VERSION env for changelog lookup');
            noEntry();
          }

          let data;
          try {
            const raw = fs.readFileSync(changelogPath, 'utf8');
            data = JSON.parse(raw);
          } catch (err) {
            console.error(`WARN: Unable to read/parse changelog: ${err.message}`);
            noEntry();
          }

          let entries = [];
          if (Array.isArray(data)) {
            entries = data;
          } else if (data && typeof data === 'object' && Array.isArray(data.entries)) {
            entries = data.entries;
          } else {
            console.error('WARN: Changelog missing entries array');
            noEntry();
          }

          const entry = entries.find(item => item && item.version === version);
          if (!entry) {
            console.error(`WARN: No changelog entry found for v${version}`);
            noEntry();
          }

          let section = `## What's New (v${version})\n`;
          if (entry.title) {
            section += `**${entry.title}**\n\n`;
          }
          if (Array.isArray(entry.changes) && entry.changes.length) {
            section += entry.changes.map(c => `- ${c}`).join('\n');
          }
          console.log(section.trimEnd());
          NODE
          )"

          {
            echo "body<<EOF"
            printf "%s\n\n" "$INSTALL_BADGE"
            if [ -n "$CHANGELOG_SECTION" ]; then
              printf "%s\n\n" "$CHANGELOG_SECTION"
            fi
            printf "## Release Notes (auto)\n%s\n" "$NOTES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        if: steps.guard.outputs.skip != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ByteByteGo Reference Linker v${{ steps.version.outputs.version }}
          body: ${{ steps.notes.outputs.body }}
          files: ${{ steps.package.outputs.asset_path }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}